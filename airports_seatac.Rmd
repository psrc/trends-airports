---
title: "Airports -- SeaTac"
output: html_notebook
---


```{r Functions, include=FALSE}
library(data.table)
library(tidyverse)
library(readxl)

dir <- "Y:/Perf Trends/Active_Trends/SeaTac_Airport/Data"

compile.seatac.pco <- function() {
  efiles <- list.files(dir, pattern = "traf-ops-", full.names = T)
  dts <- NULL
  for (efile in efiles) {
    fname <- basename(efile)
    month.num <- str_extract(fname, "\\d{2}")
    year <- str_extract(fname, "\\d{4}(?=\\.x)")
    dt <- read_excel(efile, skip =3)
    setDT(dt)
    cols <- c("..1", colnames(dt)[str_which(colnames(dt), paste0("^", month.name[as.numeric(month.num)],".*", year))])
    t <- dt[!is.na(get(eval(cols[2]))), ..cols][, `:=` (date = lubridate::ymd(paste(year, month.num, 1)))]
    setnames(t, cols, c("type", "value"))
    t[, type := str_to_lower(type)]
    ifelse(is.null(dts), dts <- t, dts <- rbindlist(list(dts, t), use.names = T))
  }
  return(dts)
}

create.seatac.subtable <- function(category = c("passenger", "all cargo", "all freight cargo", "domestic freight cargo", 
                                                "international freight cargo", "mail cargo"), totals = c("monthly", "annual")) {
  category.dict <- c("passenger" = "passenger grand total",
                     "all cargo" = "cargo grand total",
                     "all freight cargo" = "air freight grand total",
                     "domestic freight cargo" = "subtotal - domestic air freight",
                     "international freight cargo" = "subtotal - international air freight",
                     "mail cargo" = "air mail grand total")
  
  dt <- compile.seatac.pco()
  type.desc <- category.dict[category]
  
  if (totals == "monthly") {
    t <- dt[type == eval(type.desc), lapply(.SD, sum), .SDcols = "value", by = .(month(date), year(date))]
    t$month_abr <- factor(month.abb[t$month], levels = month.abb)
    t$year <- factor(t$year, levels = sort(unique(t$year)))
    t <- t[order(year, month)]
  } else {
    t <- dt[type == eval(type.desc), lapply(.SD, sum), .SDcols = "value", by = .(year(date))]
    t$year <- factor(t$year, levels = sort(unique(t$year)))
    t <- t[order(year)]
  }
  return(t)
}

cast.tbl.compute.totals <- function(table) {
  tot <- table[, lapply(.SD, sum), .SDcols = "value", by = year][, month_abr := "Total"]
  dt <- rbindlist(list(table, tot), use.names = T, fill = T)
  t <- dcast.data.table(dt, month_abr ~ year, value.var = "value")
  setnames(t, "month_abr", "Month")
  return(t)
}

export.seatac.excel <- function() {
  dt <- compile.seatac.pco()
  categories <- c("passenger", "all cargo", "all freight cargo", "domestic freight cargo", "international freight cargo", "mail cargo")
  create.seatac.subtable.monthly <- partial(create.seatac.subtable, totals = "monthly")
  dtlist <- map(categories, create.seatac.subtable.monthly) %>% map(cast.tbl.compute.totals)
  names(dtlist) <- lapply(categories, function(x) str_replace_all(x, " ", "_"))
  newfilenm <- "Airport_Passenger_Cargo_Counts_"
  wb <- createWorkbook()
  for (d in 1:length(dtlist)) {
    addWorksheet(wb, names(dtlist)[d])
    modifyBaseFont(wb, fontSize = 10, fontName = "Segoe UI Semilight")
    num <- createStyle(numFmt = "#,##0")
    writeData(wb, names(dtlist)[d], dtlist[[d]])
    addStyle(wb, names(dtlist)[d], 
             style = num, 
             cols = str_which(colnames(dtlist[[d]]), "^\\d+"), 
             rows = c(2:(nrow(dtlist[[d]])+1)), gridExpand = T, stack = T)
    saveWorkbook(wb, file = file.path(dir, paste0(newfilenm, Sys.Date(), ".xlsx")), overwrite = T)
  }
  cat("\nData exported to excel\n")
}

```

```{r Excel Export}

export.seatac.excel()

```

